<div class="flex flex-col gap-4 max-w-5xl mx-auto h-full w-full">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
        <div class="flex items-center gap-3">
            <div class="bg-primary/10 p-2 rounded-lg">
                <i class="bi bi-calendar2-range text-primary text-2xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold">Planes de Pago</h1>
                <p class="text-sm text-base-content/50">Gestiona tus planes de pago recurrentes</p>
            </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
            <!-- Refresh Button -->
            <button class="btn btn-sm btn-ghost gap-1" (click)="loadData()" title="Refrescar">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>

    <!-- Filters Bar -->
    <div class="card bg-base-200 shadow-sm">
        <div class="card-body p-3">
            <div class="flex flex-col sm:flex-row gap-3">
                <label class="input input-sm input-bordered flex items-center gap-2 flex-1">
                    <i class="bi bi-search text-base-content/40"></i>
                    <input type="text" class="grow" placeholder="Buscar por descripción, categoría..."
                        [ngModel]="searchQuery()" (ngModelChange)="onSearchChange($event)" />
                </label>

                <!-- Filtro por tipo -->
                <select class="select select-sm select-bordered w-full sm:w-36" [ngModel]="selectedTypeFilter()"
                    (ngModelChange)="onTypeFilterChange($event)">
                    <option value="all">Todos</option>
                    <option value="income">Ingresos</option>
                    <option value="expense">Gastos</option>
                </select>

                <!-- Filtro por estado del plan -->
                <select class="select select-sm select-bordered w-full sm:w-36" [ngModel]="selectedStateFilter()"
                    (ngModelChange)="onStateFilterChange($event)">
                    <option value="">Todos los estados</option>
                    <option value="ACTIVE">Activo</option>
                    <option value="PAUSED">Pausado</option>
                    <option value="CANCELLED">Cancelado</option>
                    <option value="COMPLETED">Completado</option>
                </select>

                <button class="btn btn-sm btn-ghost gap-1" (click)="toggleSort()"
                    [class.btn-active]="sortDirection() === 'desc'">
                    <i class="bi" [class.bi-sort-down]="sortDirection() === 'desc'"
                        [class.bi-sort-up]="sortDirection() === 'asc'"></i>
                    Inicio
                </button>
            </div>
        </div>
    </div>

    <!-- Summary -->
    <div class="flex items-center justify-between px-2">
        <span class="text-sm text-base-content/50">
            {{ totalPlans() }} plan{{ totalPlans() !== 1 ? 'es' : '' }}
        </span>
    </div>

    <!-- Table -->
    @if (isLoading()) {
    <div class="flex justify-center py-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>
    } @else {
    <div class="flex-1 min-h-0 flex flex-col">
        @if (tableData().length === 0) {
        <div class="flex flex-col items-center justify-center py-16 text-base-content/40">
            <i class="bi bi-calendar-x text-5xl mb-3"></i>
            <p class="text-lg font-semibold">No se encontraron planes de pago</p>
            <p class="text-sm">Ajusta los filtros o crea un nuevo plan desde Ingresos o Gastos</p>
        </div>
        } @else {
        <app-data-table [columns]="planColumns" [data]="tableData()" [showActions]="true" [actions]="planActions"
            (actionClicked)="onPlanAction($event)" />
        }
    </div>
    }
</div>

<!-- Plan detail template for dialog -->
<ng-template #planDetailTemplate>
    @if (selectedPayment()) {
    <div class="flex flex-col gap-4 h-full min-h-[500px]">
        <app-payment-detail [payment]="selectedPayment()!" [instances]="selectedInstances()"
            [categoryName]="selectedCategoryName()" [showInstancesTable]="false" />

        <div class="divider my-0"></div>

        <!-- Resumen financiero -->
        <div class="grid grid-cols-3 gap-3">
            <div class="bg-base-200 rounded-lg p-3 text-center">
                <p class="text-xs text-base-content/50 uppercase tracking-wide">Total original</p>
                <p class="text-lg font-bold">{{ selectedPayment()!.totalAmount | number: '1.2-2' }}</p>
            </div>
            <div class="bg-success/10 rounded-lg p-3 text-center">
                <p class="text-xs text-success uppercase tracking-wide">Pagado</p>
                <p class="text-lg font-bold text-success">{{ paidTotal() | number: '1.2-2' }}</p>
            </div>
            <div class="bg-warning/10 rounded-lg p-3 text-center">
                <p class="text-xs text-warning uppercase tracking-wide">Restante</p>
                <p class="text-lg font-bold text-warning">{{ remainingTotal() | number: '1.2-2' }}</p>
            </div>
        </div>

        <!-- Acciones sobre instancias -->
        <div class="flex items-center justify-between">
            <h4 class="font-semibold text-sm text-base-content/60 uppercase tracking-wide">
                <i class="bi bi-list-check me-1"></i> Gestión de instancias
                <span class="badge badge-sm badge-ghost ml-1">{{ unpaidCount() }} pendiente{{ unpaidCount() !== 1 ? 's'
                    : '' }}</span>
            </h4>
            <button class="btn btn-primary btn-sm gap-1" (click)="onAddInstance()">
                <i class="bi bi-plus-lg"></i>
                Nueva instancia
            </button>
        </div>

        <!-- Tabla editable de instancias -->
        <div class="flex-1 min-h-[300px] overflow-auto border border-base-300 rounded-lg">
            <table class="table table-zebra table-sm w-full">
                <thead class="sticky top-0 bg-base-300 z-10 w-full">
                    <tr>
                        <th class="w-12 text-center">#</th>
                        <th class="w-32">Fecha</th>
                        <th class="w-24">Monto ($)</th>
                        <th class="w-32">Estado</th>
                        <th>Comentarios</th>
                        <th class="w-12 text-center"></th>
                    </tr>
                </thead>
                <tbody>
                    @for (inst of workingInstances(); track inst.id || $index) {
                    <tr class="hover:bg-base-200/50" [class.border-l-4]="inst.state === 'PAID'"
                        [class.border-l-success]="inst.state === 'PAID'" [class.opacity-60]="inst.state === 'PAID'">
                        <td class="text-center font-semibold pt-3">{{ inst.installmentNumber }}</td>
                        <td>
                            <input type="date" class="input input-sm input-bordered w-full"
                                [(ngModel)]="inst.paymentDate" [disabled]="inst.state === 'PAID'">
                        </td>
                        <td>
                            <input type="number" step="0.01" class="input input-sm input-bordered w-full text-right"
                                [(ngModel)]="inst.amount" [disabled]="inst.state === 'PAID'">
                        </td>
                        <td>
                            <select class="select select-sm select-bordered w-full" [(ngModel)]="inst.state">
                                <option value="PENDING">Pendiente</option>
                                <option value="PAID">Pagado</option>
                                <option value="LATE">Atrasado</option>
                                <option value="CANCELLED">Cancelado</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" class="input input-sm input-bordered w-full" placeholder="Opcional..."
                                [(ngModel)]="inst.comments">
                        </td>
                        <td class="text-center">
                            @if (inst.state !== 'PAID') {
                            <button class="btn btn-ghost btn-sm btn-circle text-error"
                                (click)="removeWorkingInstance($index)" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                            } @else {
                            <i class="bi bi-lock text-base-content/30" title="Pagado - no se puede eliminar"></i>
                            }
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="modal-action flex items-center justify-end gap-2 mt-4 shrink-0">
            <button class="btn btn-ghost" (click)="cancelBatch()">Cancelar</button>
            <button class="btn btn-primary" (click)="saveBatch()" [disabled]="isLoading()">
                @if (isLoading()) { <span class="loading loading-spinner w-4 h-4"></span> }
                Guardar Cambios
            </button>
        </div>
    </div>
    }
</ng-template>