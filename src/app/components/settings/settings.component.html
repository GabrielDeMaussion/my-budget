<div class="flex flex-col gap-6 max-w-5xl mx-auto w-full">

  <!-- Header -->
  <div class="flex items-center gap-3">
    <div class="bg-primary/10 p-2 rounded-lg">
      <i class="bi bi-gear text-primary text-2xl"></i>
    </div>
    <div>
      <h1 class="text-2xl font-bold">Configuración</h1>
      <p class="text-sm text-base-content/50">Personaliza tu experiencia</p>
    </div>
  </div>

  <!-- Theme Section -->
  <div class="card bg-base-200 shadow-sm">
    <div class="card-body">
      <h2 class="card-title text-lg">
        <i class="bi bi-palette text-primary me-1"></i>
        Tema de la aplicación
      </h2>
      <div class="divider my-1"></div>

      <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
        @for (theme of themes; track theme) {
        <button class="btn btn-sm capitalize" [class.btn-primary]="currentTheme() === theme"
          [class.btn-ghost]="currentTheme() !== theme" (click)="onThemeChange(theme)" [attr.data-theme]="theme">
          <span class="flex items-center gap-1">
            @if (currentTheme() === theme) {
            <i class="bi bi-check-circle-fill text-xs"></i>
            }
            {{ theme }}
          </span>
        </button>
        }
      </div>
    </div>
  </div>

  <!-- Categories Section -->
  <div class="card bg-base-200 shadow-sm">
    <div class="card-body">
      <h2 class="card-title text-lg">
        <i class="bi bi-tags text-primary me-1"></i>
        Categorías de pago
      </h2>
      <div class="divider my-1"></div>

      <!-- Add New Root Category -->
      <div class="flex gap-2 mb-4">
        <input type="text" class="input input-sm input-bordered flex-1" [(ngModel)]="newCategoryName"
          placeholder="Nueva categoría..." (keydown.enter)="addCategory()" />
        <button class="btn btn-primary btn-sm gap-1" (click)="addCategory()" [disabled]="!newCategoryName.trim()">
          <i class="bi bi-plus-lg"></i>
          Agregar
        </button>
      </div>

      <!-- Categories List (grouped) -->
      @if (isLoading()) {
      <div class="flex justify-center py-8">
        <span class="loading loading-spinner loading-md text-primary"></span>
      </div>
      } @else {
      <div class="flex flex-col gap-1">
        @for (group of groupedCategories(); track group.parent.id) {
        <!-- Parent Category -->
        <div class="flex items-center gap-2 p-2 rounded-lg hover:bg-base-300/50 transition-colors group">
          @if (editingCategoryId() === group.parent.id) {
          <!-- Edit Mode -->
          <input type="text" class="input input-sm input-bordered flex-1" [(ngModel)]="editingCategoryValue"
            (keydown.enter)="saveEdit(group.parent)" (keydown.escape)="cancelEdit()" />
          <button class="btn btn-success btn-xs btn-ghost" (click)="saveEdit(group.parent)" title="Guardar">
            <i class="bi bi-check-lg"></i>
          </button>
          <button class="btn btn-ghost btn-xs" (click)="cancelEdit()" title="Cancelar">
            <i class="bi bi-x-lg"></i>
          </button>
          } @else {
          <!-- View Mode -->
          <button class="btn btn-ghost btn-xs p-0 min-w-[20px]" (click)="toggleExpand(group.parent.id!)"
            title="Expandir/Comprimir">
            @if (group.children.length > 0) {
            <i class="bi text-primary/60 transition-transform duration-200"
              [class.bi-folder2-open]="isExpanded(group.parent.id!)"
              [class.bi-folder]="!isExpanded(group.parent.id!)"></i>
            } @else {
            <i class="bi bi-folder text-primary/60"></i>
            }
          </button>
          <span class="flex-1 text-sm font-medium cursor-pointer" (click)="toggleExpand(group.parent.id!)">
            {{ group.parent.value }}
          </span>
          @if (group.children.length > 0 && !isExpanded(group.parent.id!)) {
          <span class="badge badge-ghost badge-xs">{{ group.children.length }}</span>
          }
          <button class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity"
            (click)="toggleAddSubcategory(group.parent.id!)" title="Agregar subcategoría">
            <i class="bi bi-plus-circle text-xs text-primary"></i>
          </button>
          <button class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity"
            (click)="startEdit(group.parent)" title="Editar">
            <i class="bi bi-pencil text-xs"></i>
          </button>
          <button class="btn btn-ghost btn-xs text-error opacity-0 group-hover:opacity-100 transition-opacity"
            (click)="deleteCategory(group.parent)" title="Eliminar">
            <i class="bi bi-trash text-xs"></i>
          </button>
          }
        </div>

        <!-- Expandable Content: Add form + subcategories -->
        @if (isExpanded(group.parent.id!)) {
        <!-- Add Subcategory Inline Form -->
        @if (addingSubcategoryTo() === group.parent.id) {
        <div class="flex gap-2 ml-8 mb-1">
          <input type="text" class="input input-xs input-bordered flex-1"
            [(ngModel)]="newSubcategoryName[group.parent.id!]"
            placeholder="Nueva subcategoría..."
            (keydown.enter)="addSubcategory(group.parent.id!)"
            (keydown.escape)="addingSubcategoryTo.set(null)" />
          <button class="btn btn-primary btn-xs gap-1" (click)="addSubcategory(group.parent.id!)"
            [disabled]="!(newSubcategoryName[group.parent.id!] || '').trim()">
            <i class="bi bi-check-lg"></i>
          </button>
          <button class="btn btn-ghost btn-xs" (click)="addingSubcategoryTo.set(null)">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        }

        <!-- Subcategories -->
        @for (sub of group.children; track sub.id) {
        <div class="flex items-center gap-2 p-2 pl-8 rounded-lg hover:bg-base-300/50 transition-colors group">
          @if (editingCategoryId() === sub.id) {
          <!-- Edit Mode -->
          <input type="text" class="input input-xs input-bordered flex-1" [(ngModel)]="editingCategoryValue"
            (keydown.enter)="saveEdit(sub)" (keydown.escape)="cancelEdit()" />
          <button class="btn btn-success btn-xs btn-ghost" (click)="saveEdit(sub)" title="Guardar">
            <i class="bi bi-check-lg"></i>
          </button>
          <button class="btn btn-ghost btn-xs" (click)="cancelEdit()" title="Cancelar">
            <i class="bi bi-x-lg"></i>
          </button>
          } @else {
          <!-- View Mode -->
          <i class="bi bi-dash text-base-content/30"></i>
          <span class="flex-1 text-sm text-base-content/80">{{ sub.value }}</span>
          <button class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity"
            (click)="startEdit(sub)" title="Editar">
            <i class="bi bi-pencil text-xs"></i>
          </button>
          <button class="btn btn-ghost btn-xs text-error opacity-0 group-hover:opacity-100 transition-opacity"
            (click)="deleteCategory(sub)" title="Eliminar">
            <i class="bi bi-trash text-xs"></i>
          </button>
          }
        </div>
        }
        } @else {
        <!-- Show add form even when collapsed if user clicked add subcategory -->
        @if (addingSubcategoryTo() === group.parent.id) {
        <div class="flex gap-2 ml-8 mb-1">
          <input type="text" class="input input-xs input-bordered flex-1"
            [(ngModel)]="newSubcategoryName[group.parent.id!]"
            placeholder="Nueva subcategoría..."
            (keydown.enter)="addSubcategory(group.parent.id!)"
            (keydown.escape)="addingSubcategoryTo.set(null)" />
          <button class="btn btn-primary btn-xs gap-1" (click)="addSubcategory(group.parent.id!)"
            [disabled]="!(newSubcategoryName[group.parent.id!] || '').trim()">
            <i class="bi bi-check-lg"></i>
          </button>
          <button class="btn btn-ghost btn-xs" (click)="addingSubcategoryTo.set(null)">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        }
        }
        } @empty {
        <div class="text-center py-8 text-base-content/40">
          <i class="bi bi-inbox text-3xl block mb-2"></i>
          <span class="text-sm">No hay categorías</span>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>

<!-- Backup & Restore -->
<div class="card bg-base-100 shadow-xl mt-6">
  <div class="card-body gap-4 p-4 sm:p-6">
    <div class="flex items-center gap-2">
      <i class="bi bi-database text-warning text-xl"></i>
      <h2 class="card-title text-base sm:text-lg">Respaldo de Seguridad</h2>
    </div>
    <p class="text-sm text-base-content/60">
      Debido a que tus datos se almacenan de forma local en el navegador, es muy importante realizar respaldos (backups)
      periódicos para evitar perder información. Puedes exportar la base de datos o restaurar un backup existente aquí.
    </p>

    <div class="flex flex-col sm:flex-row gap-4 mt-2">
      <!-- Export Button -->
      <button class="btn btn-outline btn-warning gap-2 flex-1" (click)="exportDatabase()" [disabled]="isLoading()">
        <i class="bi bi-cloud-download text-lg"></i>
        Exportar Backup
      </button>

      <!-- Import Button (Hidden Input) -->
      <input type="file" id="backupFileInput" accept=".json" class="hidden" (change)="importDatabase($event)">
      <button class="btn btn-outline btn-info gap-2 flex-1" (click)="triggerFileInput()" [disabled]="isLoading()">
        <i class="bi bi-cloud-upload text-lg"></i>
        Importar Backup
      </button>
    </div>

  </div>
</div>